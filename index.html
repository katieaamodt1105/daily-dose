<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Dose</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Pacifico&display=swap" rel="stylesheet">

<style>
body {
  font-family: Montserrat, sans-serif;
  background: #f7f5f2;
  margin: 0;
  padding: 1.5rem;
}

#app {
  max-width: 520px;
  margin: 0 auto;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 14px 40px rgba(0,0,0,0.08);
  text-align: center;
}

.date {
  font-family: Pacifico, cursive;
  font-size: 1.4rem;
  margin-bottom: 1rem;
}

.divider {
  width: 40px;
  height: 4px;
  background: rgba(0,0,0,0.1);
  margin: 0 auto 1.25rem;
  border-radius: 999px;
}

.text {
  font-size: 1rem;
  line-height: 1.8;
}

.lyric {
  font-style: italic;
}

img {
  width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 16px;
  margin-top: 1rem;
}

iframe {
  width: 100%;
  margin-top: 1rem;
  border-radius: 14px;
}
</style>
</head>

<body>
<main class="card"> <div id="date" class="date">Your daily dose ☕️</div> <div class="divider"></div> <p id="content" class="text-content"></p> <div class="photo-wrapper"> <img id="image" /> </div> <iframe id="gif" width="100%" height="280" frameborder="0" allowfullscreen style="display:none; border-radius:18px;"> </iframe> <iframe id="spotify" width="100%" height="152" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"> </iframe> </main>
<script>
const SHEET_ID = "1E9gjeth0nx2iel6OWRpkDVdxUlqRrZJW8r6-zQky4aw";
const SHEET_NAME = "Daily Dose";

const params = new URLSearchParams(window.location.search);
const preview = params.get("preview")?.toLowerCase() || null;

function normalize(v) {
  return String(v || "").toLowerCase().trim();
}

function formatDate(d) {
  return d.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric"
  });
}

const query = encodeURIComponent("SELECT A,B,C,D,E");
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;

fetch(url)
  .then(r => r.text())
  .then(text => {
    const json = JSON.parse(text.slice(text.indexOf("{"), text.lastIndexOf("}") + 1));
    const rows = json.table.rows;

    const app = document.getElementById("app");
    app.innerHTML = "";

    if (!rows || !rows.length) {
      app.innerText = "No rows found.";
      return;
    }

    console.log("ROWS:", rows.length);

    // PREVIEW ALL
    if (preview === "all") {
      app.className = "grid";

      rows.forEach(r => {
        if (!r.c) return;

        const type = normalize(r.c[1]?.v ?? r.c[1]?.f);
        const text = r.c[2]?.v || "";
        const image = r.c[3]?.v;
        const spotify = r.c[4]?.v;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="date">${type || "—"}</div>
          <div class="divider"></div>
          <div class="text ${type === "lyric" ? "lyric" : ""}">${text}</div>
        `;

        if (image) {
          const img = document.createElement("img");
          img.src = image;
          card.appendChild(img);
        }

        if (type === "lyric" && spotify) {
          const iframe = document.createElement("iframe");
          iframe.height = "152";
          iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
          iframe.src = spotify.includes("/embed/")
            ? spotify
            : spotify.replace("https://open.spotify.com/", "https://open.spotify.com/embed/");
          card.appendChild(iframe);
        }

        app.appendChild(card);
      });

      return;
    }

    // SINGLE ITEM
    const today = new Date();
    const m = today.getMonth();
    const d = today.getDate();

    let match = rows.find(r => {
      if (!r.c?.[0]?.v) return false;
      const rd = new Date(r.c[0].v);
      return rd.getMonth() === m && rd.getDate() === d;
    }) || rows[d % rows.length];

    let source = match;

    if (preview) {
      const matches = rows.filter(r => {
        const raw = r.c?.[1];
        const val = raw?.v ?? raw?.f;
        return normalize(val) === preview;
      });
      if (matches.length) source = matches[Math.floor(Math.random() * matches.length)];
    }

    if (!source?.c) {
      app.innerText = "No content to display.";
      return;
    }

    const type = normalize(source.c[1]?.v ?? source.c[1]?.f);
    const text = source.c[2]?.v || "";
    const image = source.c[3]?.v;
    const spotify = source.c[4]?.v;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="date">${formatDate(today)}</div>
      <div class="divider"></div>
      <div class="text ${type === "lyric" ? "lyric" : ""}">${text}</div>
    `;

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      card.appendChild(img);
    }

    if (type === "lyric" && spotify) {
      const iframe = document.createElement("iframe");
      iframe.height = "152";
      iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.src = spotify.includes("/embed/")
        ? spotify
        : spotify.replace("https://open.spotify.com/", "https://open.spotify.com/embed/");
      card.appendChild(iframe);
    }

    app.appendChild(card);
  })
  .catch(err => {
    console.error(err);
    document.getElementById("app").innerText = "Error loading content.";
  });
</script>
</body>
</html>
