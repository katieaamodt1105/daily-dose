<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Dose</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Pacifico&display=swap" rel="stylesheet">

<style>
body {
  font-family: Montserrat, sans-serif;
  background: #f7f5f2;
  margin: 0;
  padding: 1.5rem;
}

#app {
  max-width: 520px;
  margin: 0 auto;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 14px 40px rgba(0,0,0,0.08);
  text-align: center;
}

.date {
  font-family: Pacifico, cursive;
  font-size: 1.4rem;
  margin-bottom: 1rem;
}

.divider {
  width: 40px;
  height: 4px;
  background: rgba(0,0,0,0.1);
  margin: 0 auto 1.25rem;
  border-radius: 999px;
}

.text {
  font-size: 1rem;
  line-height: 1.8;
}

.lyric {
  font-style: italic;
}

img {
  width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 16px;
  margin-top: 1rem;
}

iframe {
  width: 100%;
  margin-top: 1rem;
  border-radius: 14px;
}
</style>
</head>

<body>
<div id="app"></div>

<script>
  
const SHEET_ID = "1E9gjeth0nx2iel6OWRpkDVdxUlqRrZJW8r6-zQky4aw";
const SHEET_NAME = "Daily Dose";

const params = new URLSearchParams(window.location.search);
const preview = params.get("preview")?.toLowerCase() || null;

function normalize(v) {
  return String(v || "").toLowerCase().trim();
}

function formatDate(d) {
  return d.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric"
  });
}
  function isFirstVisit() {
  const params = new URLSearchParams(window.location.search);
  if (params.get("reset") === "true") {
    localStorage.removeItem("dailyDoseSeen");
    return true;
  }

  return !localStorage.getItem("dailyDoseSeen");
}

function markVisited() {
  localStorage.setItem("dailyDoseSeen", "true");
}


const query = encodeURIComponent("SELECT A,B,C,D,E");
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;

function renderWelcome(app) {
  const card = document.createElement("div");
  card.className = "card";

  card.innerHTML = `
    <div class="date">Hi üíõ</div>
    <div class="divider"></div>
    <div class="text">
      This is your <strong>Daily Dose</strong> ‚òïÔ∏è<br><br>
      Every day when you scan this mug, you‚Äôll get
      a little something made just for you ‚Äî<br>
      a quote, a laugh, a song, or a reminder you didn‚Äôt know you needed.
      <br><br>
      Come back anytime. It changes daily ‚ú®
    </div>
  `;

  app.appendChild(card);

  // Mark as seen after rendering
  markVisited();
}

  
fetch(url)
  .then(res => res.text())
  .then(raw => {
    const json = JSON.parse(
      raw.slice(raw.indexOf("{"), raw.lastIndexOf("}") + 1)
    );
    const rows = json.table.rows || [];

    const app = document.getElementById("app");
    app.innerHTML = "";

    const forceWelcome = preview === "welcome";

if (forceWelcome || isFirstVisit()) {
  renderWelcome(app);
  return;
}


    if (!rows.length) {
      app.innerText = "No content found.";
      return;
    }

    /* ===========================
       PREVIEW ALL
    =========================== */
    if (preview === "all") {
      app.className = "grid";

      rows.forEach(row => {
        if (!row.c) return;

        const type = normalize(row.c[1]?.v ?? row.c[1]?.f);
        const bodyText = row.c[2]?.v || "";
        const image = row.c[3]?.v;
        const spotify = row.c[4]?.v;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="date">${type || "‚Äî"}</div>
          <div class="divider"></div>
          <div class="text ${type === "lyric" ? "lyric" : ""}">
            ${bodyText}
          </div>
        `;

        if (image) {
          const img = document.createElement("img");
          img.src = image;
          card.appendChild(img);
        }

        if (type === "lyric" && spotify) {
          const iframe = document.createElement("iframe");
          iframe.height = "152";
          iframe.allow =
            "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
          iframe.src = spotify.includes("/embed/")
            ? spotify
            : spotify.replace(
                "https://open.spotify.com/",
                "https://open.spotify.com/embed/"
              );
          card.appendChild(iframe);
        }

        app.appendChild(card);
      });

      return;
    }

    /* ===========================
       SINGLE ITEM
    =========================== */
    const today = new Date();
    const m = today.getMonth();
    const d = today.getDate();

    let source =
      rows.find(r => {
        const cell = r.c?.[0]?.v;
        if (!cell) return false;
        const rd = new Date(cell);
        return rd.getMonth() === m && rd.getDate() === d;
      }) || rows[d % rows.length];

    if (preview) {
      const filtered = rows.filter(r => {
        const cell = r.c?.[1]?.v ?? r.c?.[1]?.f;
        return normalize(cell) === preview;
      });
      if (filtered.length) {
        source = filtered[Math.floor(Math.random() * filtered.length)];
      }
    }

    if (!source?.c) {
      app.innerText = "No content to display.";
      return;
    }

    const type = normalize(source.c[1]?.v ?? source.c[1]?.f);
    const bodyText = source.c[2]?.v || "";
    const image = source.c[3]?.v;
    const spotify = source.c[4]?.v;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="date">${formatDate(today)}</div>
      <div class="divider"></div>
      <div class="text ${type === "lyric" ? "lyric" : ""}">
        ${bodyText}
      </div>
    `;

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      card.appendChild(img);
    }

    if (type === "lyric" && spotify) {
      const iframe = document.createElement("iframe");
      iframe.height = "152";
      iframe.allow =
        "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.src = spotify.includes("/embed/")
        ? spotify
        : spotify.replace(
            "https://open.spotify.com/",
            "https://open.spotify.com/embed/"
          );
      card.appendChild(iframe);
    }

    app.appendChild(card);
  })
  .catch(err => {
    console.error(err);
    document.getElementById("app").innerText = "Error loading content.";
  });
</script>
</body>
</html>
