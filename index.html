<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Dose</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Pacifico&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Montserrat', sans-serif;
  background: #f7f5f2;
  margin: 0;
  padding: 1.5rem;
}

.preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
}

.card {
  background: #fff;
  border-radius: 22px;
  padding: 2rem;
  box-shadow: 0 14px 40px rgba(0,0,0,0.08);
  text-align: center;
}

.date {
  font-family: 'Pacifico', cursive;
  font-size: 1.3rem;
  margin-bottom: 1rem;
}

.divider {
  width: 40px;
  height: 4px;
  background: rgba(0,0,0,0.1);
  margin: 0 auto 1.25rem;
  border-radius: 999px;
}

.text {
  font-size: 1rem;
  line-height: 1.9;
}

.lyric {
  font-style: italic;
}

img {
  width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 16px;
  margin-top: 1rem;
}

iframe {
  width: 100%;
  border-radius: 14px;
  margin-top: 1rem;
}

.birthday {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 999;
}

.birthday span {
  font-family: 'Pacifico', cursive;
  font-size: clamp(3rem, 10vw, 6rem);
  color: #ff6f61;
}
</style>
</head>

<body>

<div id="app"></div>

<script>
/* ======================
   CONFIG
====================== */
const SHEET_ID = "1E9gjeth0nx2iel6OWRpkDVdxUlqRrZJW8r6-zQky4aw";
const SHEET_NAME = "Daily Dose";

/* ======================
   HELPERS
====================== */
const params = new URLSearchParams(window.location.search);

const preview = params.get("preview")?.toLowerCase().trim() || null;
const overrideDate = params.get("date") ? new Date(params.get("date")) : null;

function normalize(val) {
  return String(val || "").toLowerCase().trim();
}

function formatDate(d) {
  return d.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric"
  });
}

/* ======================
   FETCH SHEET
====================== */
const query = encodeURIComponent("SELECT A,B,C,D,E");
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;

fetch(url)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
    const rows = json.table.rows;
    if (!rows || !rows.length) throw new Error("No data");

    const app = document.getElementById("app");

    /* ======================
       PREVIEW ALL
    ====================== */
    if (preview === "all") {
      app.className = "preview-grid";

      rows.forEach(r => {
        if (!r.c) return;

        const date = r.c[0]?.v ? formatDate(new Date(r.c[0].v)) : "â€”";
        const type = normalize(r.c[1]?.v ?? r.c[1]?.f);
        const text = r.c[2]?.v || "";
        const image = r.c[3]?.v;
        const spotify = r.c[4]?.v;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="date">${type || "no type"}</div>
          <div class="divider"></div>
          <div class="text ${type === "lyric" ? "lyric" : ""}">${text}</div>
        `;

        if (image) {
          const img = document.createElement("img");
          img.src = image;
          card.appendChild(img);
        }

        if (type === "lyric" && spotify) {
          const iframe = document.createElement("iframe");
          iframe.height = "152";
          iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
          iframe.src = spotify.includes("/embed/")
            ? spotify
            : spotify.replace("https://open.spotify.com/", "https://open.spotify.com/embed/");
          card.appendChild(iframe);
        }

        app.appendChild(card);
      });

      return;
    }

    /* ======================
       SINGLE ITEM MODE
    ====================== */
    const today = overrideDate || new Date();
    const m = today.getMonth();
    const d = today.getDate();

    let daily = rows.find(r => {
      if (!r.c?.[0]?.v) return false;
      const rd = new Date(r.c[0].v);
      return rd.getMonth() === m && rd.getDate() === d;
    }) || rows[d % rows.length];

    let source = daily;

    if (preview) {
      const matches = rows.filter(r => {
        const raw = r.c?.[1];
        const val = raw?.v ?? raw?.f;
        return normalize(val) === preview;
      });
      if (matches.length) {
        source = matches[Math.floor(Math.random() * matches.length)];
      }
    }

    if (!source?.c) throw new Error("No row selected");

    const type = normalize(source.c[1]?.v ?? source.c[1]?.f);
    const text = source.c[2]?.v || "";
    const image = source.c[3]?.v;
    const spotify = source.c[4]?.v;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="date">${formatDate(today)}</div>
      <div class="divider"></div>
      <div class="text ${type === "lyric" ? "lyric" : ""}">${text}</div>
    `;

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      card.appendChild(img);
    }

    if (type === "lyric" && spotify) {
      const iframe = document.createElement("iframe");
      iframe.height = "152";
      iframe.allow = "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.src = spotify.includes("/embed/")
        ? spotify
        : spotify.replace("https://open.spotify.com/", "https://open.spotify.com/embed/");
      card.appendChild(iframe);
    }

    app.appendChild(card);

    /* ======================
       BIRTHDAY
    ====================== */
    if (today.getMonth() === 5 && today.getDate() === 21) {
      const b = document.createElement("div");
      b.className = "birthday";
      b.innerHTML = "<span>HAPPY BIRTHDAY! ðŸŽ‰</span>";
      document.body.appendChild(b);
    }

  })
  .catch(err => {
    document.getElementById("app").innerText = "Error loading content.";
    console.error(err);
  });
</script>

</body>
</html>
