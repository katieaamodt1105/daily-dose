<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Dose</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Pacifico&display=swap" rel="stylesheet">

<style>
body {
  font-family: Montserrat, sans-serif;
  background: #f7f5f2;
  margin: 0;
  padding: 1.5rem;
}

#app {
  max-width: 520px;
  margin: 0 auto;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1.5rem;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 2rem;
  box-shadow: 0 14px 40px rgba(0,0,0,0.08);
  text-align: center;
}

.date {
  font-family: Pacifico, cursive;
  font-size: 1.4rem;
  margin-bottom: 1rem;
}

.divider {
  width: 40px;
  height: 4px;
  background: rgba(0,0,0,0.1);
  margin: 0 auto 1.25rem;
  border-radius: 999px;
}

.text {
  font-size: 1rem;
  line-height: 1.8;
}
  .poem {
  font-size: 1rem;
  line-height: 1.8;
    align: left;
}

.lyric {
  font-style: italic;
}

img {
  width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 16px;
  margin-top: 1rem;
}

iframe {
  width: 100%;
  margin-top: 1rem;
  border-radius: 14px;
}
</style>
</head>

<body>
<div id="app"></div>

<script>
  
const SHEET_ID = "1E9gjeth0nx2iel6OWRpkDVdxUlqRrZJW8r6-zQky4aw";
const SHEET_NAME = "Daily Dose";

const params = new URLSearchParams(window.location.search);
const preview = params.get("preview")?.toLowerCase() || null;

function normalize(v) {
  return String(v || "").toLowerCase().trim();
}

  function getOverrideDate() {
  const params = new URLSearchParams(window.location.search);
  const dateParam = params.get("date");
  if (!dateParam) return null;

  const d = new Date(dateParam);
  return isNaN(d) ? null : d;
}

function formatDate(d) {
  return d.toLocaleDateString(undefined, {
    weekday: "long",
    month: "long",
    day: "numeric"
  });
}
  function isFirstVisit() {
  const params = new URLSearchParams(window.location.search);
  if (params.get("reset") === "true") {
    localStorage.removeItem("dailyDoseSeen");
    return true;
  }

  return !localStorage.getItem("dailyDoseSeen");
}

function markVisited() {
  localStorage.setItem("dailyDoseSeen", "true");
}


const query = encodeURIComponent("SELECT A,B,C,D,E");
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;

function renderWelcome(app) {
  const card = document.createElement("div");
  card.className = "card";

  card.innerHTML = `
  <div class="date">Merry Christmas, Katie üéÑ</div>
  <div class="divider"></div>

 <div class="poem">
  <span style="color:#b11226;">‚ÄôTwas the night of Cribmas</span>
  <span style="color:#2f6f4e;"> and all through the crib,</span><br>
  <span style="color:#2f6f4e;">The girlfriends were giggling</span>
  <span style="color:#b11226;"> till it hurt their ribs.</span><br><br>

  <span style="color:#b11226;">A gift was exchanged,</span>
  <span style="color:#2f6f4e;"> a small festive surprise ‚Äî</span><br>
  <span style="color:#2f6f4e;">From a Secret Santa</span>
  <span style="color:#b11226;"> to her girlfriend, KY üéÅ</span><br><br>

  <span style="color:#2f6f4e;">It‚Äôs a mug for your coffee,</span>
  <span style="color:#b11226;"> but it‚Äôs so much more,</span><br>
  <span style="color:#b11226;">When you scan the code,</span>
  <span style="color:#2f6f4e;"> you'll see treasures galore.</span><br><br>

  <span style="color:#b11226;">Each morning you sip,</span>
  <span style="color:#2f6f4e;"> something fresh will appear,</span><br>
  <span style="color:#2f6f4e;">A new little moment of BWMGFS</span>
  <span style="color:#b11226;"> will be waiting right here.</span><br><br>

  <span style="color:#2f6f4e;">Some days it‚Äôs a quote,</span>
  <span style="color:#b11226;"> or a photo, or song,</span><br>
  <span style="color:#b11226;">Some days just a nudge</span>
  <span style="color:#2f6f4e;"> when the day feels too long.</span><br><br>

  <span style="color:#b11226;">It‚Äôs made just for you,</span>
  <span style="color:#2f6f4e;"> a small moment of cheer,</span><br>
  <span style="color:#2f6f4e;">A daily reminder:</span>
  <span style="color:#b11226;"> I‚Äôm always right here.</span><br><br>

  <span style="color:#b11226;">So come back tomorrow,</span>
  <span style="color:#2f6f4e;"> and the next day too,</span><br>
  <span style="color:#2f6f4e;">Your</span>
  <strong style="color:#c9a24d;"> Daily Dose of BWMGFS</strong>
  <span style="color:#b11226;"> ‚òïÔ∏è will be waiting for you ‚ú®</span>
</div>

  <div class="divider"></div>

<div class="date">Example: December 25 üéÑ</div>

<div class="divider"></div>

<img
  src="https://media1.tenor.com/m/DvO-ao8Rsh8AAAAd/the-office-presents.gif"
  alt="Christmas presents moment"
  style="margin-bottom:1rem;"
/>

<div class="text lyric">
  ‚ÄúChristmas isn‚Äôt a season. It‚Äôs a feeling.‚Äù<br>
  ‚Äî Edna Ferber
</div>

<div class="text" style="font-size:0.85rem; opacity:0.7;">
  Come back tomorrow for something new ‚ú®
</div>


`;

  app.appendChild(card);

  // Mark as seen after rendering
  markVisited();
}

  
fetch(url)
  .then(res => res.text())
  .then(raw => {
    const json = JSON.parse(
      raw.slice(raw.indexOf("{"), raw.lastIndexOf("}") + 1)
    );
    const rows = json.table.rows || [];

    const app = document.getElementById("app");
    app.innerHTML = "";

    const forceWelcome = preview === "welcome";

if (forceWelcome || isFirstVisit()) {
  renderWelcome(app);
  return;
}


    if (!rows.length) {
      app.innerText = "No content found.";
      return;
    }

    /* ===========================
       PREVIEW ALL
    =========================== */
    // PREVIEW ALL
if (preview === "all") {
  app.className = "grid";

  rows.forEach(r => {
    if (!r.c) return;

    const type = normalize(r.c[1]?.v ?? r.c[1]?.f);
    const bodyText = r.c[2]?.v || "";
    const image = r.c[3]?.v;
    const spotify = r.c[4]?.v;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="date">${type || "‚Äî"}</div>
      <div class="divider"></div>
      <div class="text ${type === "lyric" ? "lyric" : ""}">
        ${bodyText}
      </div>
    `;

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      card.appendChild(img);
    }

    if (type === "lyric" && spotify) {
      const iframe = document.createElement("iframe");
      iframe.height = "152";
      iframe.allow =
        "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.src = spotify.includes("/embed/")
        ? spotify
        : spotify.replace(
            "https://open.spotify.com/",
            "https://open.spotify.com/embed/"
          );
      card.appendChild(iframe);
    }

    app.appendChild(card);
  });

  return;
}


    /* ===========================
       SINGLE ITEM
    =========================== */
const today = getOverrideDate() || new Date();
    const m = today.getMonth();
    const d = today.getDate();

    let source =
      rows.find(r => {
        const cell = r.c?.[0]?.v;
        if (!cell) return false;
        const rd = new Date(cell);
        return rd.getMonth() === m && rd.getDate() === d;
      }) || rows[d % rows.length];

    if (preview) {
      const filtered = rows.filter(r => {
        const cell = r.c?.[1]?.v ?? r.c?.[1]?.f;
        return normalize(cell) === preview;
      });
      if (filtered.length) {
        source = filtered[Math.floor(Math.random() * filtered.length)];
      }
    }

    if (!source?.c) {
      app.innerText = "No content to display.";
      return;
    }

    const type = normalize(source.c[1]?.v ?? source.c[1]?.f);
    const bodyText = source.c[2]?.v || "";
    const image = source.c[3]?.v;
    const spotify = source.c[4]?.v;

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="date">${formatDate(today)}</div>
      <div class="divider"></div>
      <div class="text ${type === "lyric" ? "lyric" : ""}">
        ${bodyText}
      </div>
    `;

    if (image) {
      const img = document.createElement("img");
      img.src = image;
      card.appendChild(img);
    }

    if (type === "lyric" && spotify) {
      const iframe = document.createElement("iframe");
      iframe.height = "152";
      iframe.allow =
        "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture";
      iframe.src = spotify.includes("/embed/")
        ? spotify
        : spotify.replace(
            "https://open.spotify.com/",
            "https://open.spotify.com/embed/"
          );
      card.appendChild(iframe);
    }

    app.appendChild(card);
  })
  .catch(err => {
    console.error(err);
    document.getElementById("app").innerText = "Error loading content.";
  });
</script>
</body>
</html>
